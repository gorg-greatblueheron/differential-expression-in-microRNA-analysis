
---
title: "Transcriptomics R file"
author: "Hang Lei"
date: "2025-05-03"
output: html_document
---

## Load Required Packages
```{r setup, message=FALSE}
required_cran <- c("readxl", "dplyr", "stringr", "tibble", "tidyr", "ggplot2", "pheatmap")
installed <- rownames(installed.packages())
to_install <- setdiff(required_cran, installed)
if(length(to_install)) install.packages(to_install)

if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")
if (!"limma" %in% installed) BiocManager::install("limma")

library(readxl)
library(dplyr)
library(stringr)
library(tidyr)
library(ggplot2)
library(tibble)
library(limma)
library(pheatmap)
```

## Load and Filter Data
```{r}
data <- read_excel("GSE285580_All_data.xlsx")
new_data <- read_excel("GSE285580_All_data.xlsx", skip = 48)
new_data_unique <- new_data %>% filter(!duplicated(miR_name))
```

## Extract Expression Matrix
```{r}
expr_cols <- grep("\(norm\)$", colnames(new_data), value = TRUE)
expr_matrix <- new_data_unique %>%
  select(miR_name, all_of(expr_cols)) %>%
  column_to_rownames("miR_name")
colnames(expr_matrix) <- gsub("\(norm\)", "", colnames(expr_matrix))
```

## Create Sample Metadata
```{r}
sample_info <- data.frame(
  sample_id = colnames(expr_matrix),
  genotype = c(rep("HbAA", 13), rep("HbAS", 13), rep("HbSS", 13))
)
all(sample_info$sample_id == colnames(expr_matrix))
```

## Differential Expression Analysis
```{r}
expr_matrix <- as.matrix(expr_matrix)
group <- factor(sample_info$genotype, levels = c("HbAA", "HbAS", "HbSS"))
design <- model.matrix(~ 0 + group)
colnames(design) <- levels(group)
fit <- lmFit(expr_matrix, design)

contrast.matrix <- makeContrasts(
  HbASvsHbAA = HbAS - HbAA,
  HbSSvsHbAA = HbSS - HbAA,
  HbSSvsHbAS = HbSS - HbAS,
  levels = design
)

fit2 <- contrasts.fit(fit, contrast.matrix)
fit2 <- eBayes(fit2)
```

## Extract DE Results
```{r}
results_AS <- topTable(fit2, coef = "HbASvsHbAA", adjust = "fdr", number = Inf)
results_SS <- topTable(fit2, coef = "HbSSvsHbAA", adjust = "fdr", number = Inf)
results_SSvsAS <- topTable(fit2, coef = "HbSSvsHbAS", adjust = "fdr", number = Inf)
```

## Volcano Plots
```{r}
ggplot(results_AS, aes(x = logFC, y = -log10(P.Value), color = adj.P.Val < 0.05)) +
  geom_point() + theme_minimal() +
  labs(title = "Volcano Plot: HbAS vs HbAA", x = "log2 Fold Change", y = "-log10(P-value)")

ggplot(results_SS, aes(x = logFC, y = -log10(P.Value), color = adj.P.Val < 0.05)) +
  geom_point() + theme_minimal() +
  labs(title = "Volcano Plot: HbSS vs HbAA", x = "log2 Fold Change", y = "-log10(P-value)")

ggplot(results_SSvsAS, aes(x = logFC, y = -log10(P.Value), color = adj.P.Val < 0.05)) +
  geom_point() + theme_minimal() +
  labs(title = "Volcano Plot: HbSS vs HbAS", x = "log2 Fold Change", y = "-log10(P-value)")
```

## Identify Significant miRNAs
```{r}
sig_AS <- results_AS %>% filter(adj.P.Val < 0.05)
sig_SS <- results_SS %>% filter(adj.P.Val < 0.05)
sig_SSvsAS <- results_SSvsAS %>% filter(adj.P.Val < 0.05)
```

## Heatmap of Top 20 DE miRNAs (HbSS vs HbAA)
```{r}
results_SS_tbl <- results_SS %>%
  rownames_to_column(var = "miRNA") %>%
  as_tibble()

top_miRNAs <- results_SS_tbl %>%
  arrange(adj.P.Val) %>%
  dplyr::slice(1:20) %>%
  pull(miRNA)

heatmap_matrix <- expr_matrix[top_miRNAs, ]
sample_info_annot <- sample_info %>% column_to_rownames("sample_id")

pheatmap(heatmap_matrix,
         scale = "row",
         annotation_col = sample_info_annot,
         clustering_distance_cols = "euclidean",
         clustering_method = "complete",
         show_rownames = TRUE,
         fontsize_row = 8)
```

## miRNA Target Prediction Using multiMiR
```{r}
if (!"multiMiR" %in% installed) BiocManager::install("multiMiR")
library(multiMiR)

validated_targets <- get_multimir(mirna = top_miRNAs,
                                  table = "validated",
                                  summary = TRUE)

validated_df <- as.data.frame(validated_targets@data)
```

## Extract Unique Gene Symbols
```{r}
target_genes <- validated_df %>%
  pull(target_symbol) %>%
  unique()
```

## GO Enrichment Analysis
```{r}
if (!"clusterProfiler" %in% installed) BiocManager::install("clusterProfiler")
if (!"org.Hs.eg.db" %in% installed) BiocManager::install("org.Hs.eg.db")

library(clusterProfiler)
library(org.Hs.eg.db)

gene_df <- bitr(target_genes,
                fromType = "SYMBOL",
                toType = "ENTREZID",
                OrgDb = org.Hs.eg.db)

entrez_genes <- unique(gene_df$ENTREZID)

go_results <- enrichGO(gene = entrez_genes,
                       OrgDb = org.Hs.eg.db,
                       keyType = "ENTREZID",
                       ont = "ALL",
                       pAdjustMethod = "BH",
                       pvalueCutoff = 0.05,
                       qvalueCutoff = 0.2,
                       readable = TRUE)
```

## Visualize GO Enrichment
```{r}
dotplot(go_results, showCategory = 20, split = "ONTOLOGY") + 
  ggplot2::facet_wrap(~ONTOLOGY, scales = "free")

barplot(go_results, showCategory = 10, title = "Top GO Terms")
```

## Inflammation-Related GO Terms
```{r}
inflammatory_terms <- go_results@result %>%
  filter(grepl("inflamm|immune|cytokine|macrophage", Description, ignore.case = TRUE)) %>%
  select(ID, Description, Count, p.adjust)

inflammatory_terms
```

## Network Visualization of miRNA–Gene–GO
```{r}
library(igraph)
library(ggraph)

top_validated_targets <- validated_df %>%
  filter(mature_mirna_id %in% top_miRNAs) %>%
  distinct(mature_mirna_id, target_symbol)

go_result_df <- as.data.frame(go_results@result)

inflamm_go_terms <- go_result_df %>%
  filter(p.adjust < 0.05) %>%
  filter(grepl("inflamm|immune|cytokine|macrophage", Description, ignore.case = TRUE)) %>%
  select(ID, Description, geneID) %>%
  separate_rows(geneID, sep = "/")

inflamm_targets <- top_validated_targets %>%
  inner_join(inflamm_go_terms, by = c("target_symbol" = "geneID")) %>%
  distinct(mature_mirna_id, target_symbol, Description)

top_mirnas_to_plot <- inflamm_targets %>%
  count(mature_mirna_id, sort = TRUE) %>%
  slice(1:5) %>%
  pull(mature_mirna_id)

filtered_targets <- inflamm_targets %>%
  filter(mature_mirna_id %in% top_mirnas_to_plot)

edges_mir_gene <- filtered_targets %>%
  select(from = mature_mirna_id, to = target_symbol) %>%
  mutate(type = "miRNA-target")

edges_gene_go <- filtered_targets %>%
  select(from = target_symbol, to = Description) %>%
  mutate(type = "target-GO")

edges_small <- bind_rows(edges_mir_gene, edges_gene_go)

graph_small <- graph_from_data_frame(edges_small, directed = TRUE)
V(graph_small)$type <- ifelse(V(graph_small)$name %in% top_mirnas_to_plot, "miRNA",
                              ifelse(V(graph_small)$name %in% edges_gene_go$to, "GO term",
                                     "target gene"))

ggraph(graph_small, layout = "fr") +
  geom_edge_link(aes(color = type), alpha = 0.5) +
  geom_node_point(aes(color = type), size = 5) +
  geom_node_text(aes(label = name), repel = TRUE, size = 3) +
  theme_void() +
  labs(title = "Top 5 miRNAs Linked to Immune Pathways") +
  scale_color_manual(values = c("miRNA" = "tomato", "target gene" = "steelblue", "GO term" = "forestgreen"))
```
